---
import StarlightPage from "@astrojs/starlight/components/StarlightPage.astro";
import type { PaginatedResponse, SupportPage } from "../../types/payload";

type StaticPath = {
  params: { slug: string };
  props: { id: string };
};

export async function getStaticPaths() {
  const PAYLOAD_URL = import.meta.env.PUBLIC_PAYLOAD_URL;

  const res = await fetch(`${PAYLOAD_URL}/api/support-pages?limit=200&where[_status][equals]=published`);
  const data = (await res.json()) as PaginatedResponse<SupportPage>;

  return (data.docs ?? [])
    .filter((p): p is SupportPage & { id: string; slug: string } => Boolean(p?.id && p?.slug))
    .map<StaticPath>((p) => ({
      params: { slug: p.slug },
      props: { id: p.id },
    }));
}

const PAYLOAD_URL = import.meta.env.PUBLIC_PAYLOAD_URL;
const { id } = Astro.props as StaticPath["props"];

const res = await fetch(`${PAYLOAD_URL}/api/support-pages/${id}`);
const page = (await res.json()) as SupportPage;
---

<StarlightPage frontmatter={{ title: page.title ?? "Support Article" }}>
  <article>
    <h1>{page.title ?? "Support Article"}</h1>
    <!-- body is Markdown in this approach; simplest first pass is render as preformatted -->
    <!-- Better: convert Markdown -> HTML using an Astro markdown pipeline -->
    <div>
      <pre style="white-space: pre-wrap;">{page.body ?? ""}</pre>
    </div>
  </article>
</StarlightPage>
