---
import StarlightPage from "@astrojs/starlight/components/StarlightPage.astro";
import type { PaginatedResponse, SupportCategory, SupportPage } from "../../types/payload";

type StaticPath = {
  params: { slug: string };
  props: { slug: string; categorySlug: string };
};

export async function getStaticPaths() {
  const PAYLOAD_URL = import.meta.env.PUBLIC_PAYLOAD_URL;

  const res = await fetch(
    `${PAYLOAD_URL}/api/support-pages?limit=500&depth=1&where[_status][equals]=published`,
  );
  const data = (await res.json()) as PaginatedResponse<SupportPage>;

  return (data.docs ?? [])
    .filter(
      (
        p,
      ): p is SupportPage & {
        slug: string;
        category: SupportCategory;
      } =>
        Boolean(
          p?.slug &&
            typeof p.category === "object" &&
            p.category !== null &&
            (p.category as SupportCategory).slug,
        ),
    )
    .map<StaticPath>((p) => ({
      params: { slug: p.slug },
      props: {
        slug: p.slug,
        categorySlug: (p.category as SupportCategory).slug,
      },
    }));
}

const { slug, categorySlug } = Astro.props as StaticPath["props"];
return Astro.redirect(`/support/${categorySlug}/${slug}`);
---

<StarlightPage frontmatter={{ title: "Redirecting..." }}>
  <p>Redirectingâ€¦</p>
</StarlightPage>
